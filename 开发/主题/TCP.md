# TCP

## TCP 三次握手和四次挥手？

三次握手，(SYN, SEQ=x) -> (SYN, ACK=x+1, SEQ=y) -> (ACK=y+1)，二次不行是因为 TCP 是面向连接的全双工，四次不行是没有必要消耗多余的一次网络传输。（如果去掉最后一次 ACK 的话极端情况就是 SYN Flood 攻击）

四次挥手，(FIN, SEQ=x) -> (ACK=x+1) -> [服务端 CLOSE_WAIT 并发送完剩余数据] -> (FIN, SEQ=y) -> (ACK=y+1) -> [客户端 TIME_WAIT] -> (经过2MSL，默认四分钟后 CLOSED) ，四次挥手服务端 FIN 和 ACK 没有在一次传输发送是等待服务端把数据发送完，防止数据丢失。客户端等待 2MSL 是为了最后一个 ACK 能到达服务端帮助其关闭连接（假设服务端没有收到最后来自客户端的 ACK，那么会重新发送 FIN）；另外也是为了防止新连接中存在旧连接的报文（因为在 2MSL 时间内上次的网络包肯定已经不存在了）。

[面试必备HTTP之TCP三次握手及四次挥手详解 - 简书 (jianshu.com)](https://www.jianshu.com/p/12790cea57ac)

[简单理解TCP三次握手四次挥手（看一遍你就懂）-CSDN博客](https://blog.csdn.net/m0_56649557/article/details/119492899)

## 出现大量 TIME_WAIT 的原因？

出现大量 TIME_WAIT 一般是由于短时间内大量请求，一般发生在客户端，由于 HTTP1.1(Header, Connection=close 时) 是服务端先断开连接，所以对于 HTTP 服务器来说服务端也会出现大量 TIME_WAIT。(Header, Connection 另一个选项是 keep-alive)

[终于搞懂了服务器为啥产生大量的TIME_WAIT！ - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/415307243)

## MSS 是什么？

MSS（Maximum Segment Size，最大报文长度），是 TCP 协议定义的一个选项，MSS 选项用于在 TCP 连接建立时，收发双方协商通信时每一个报文段所能承载的最大数据长度，最大程度地减少数据传输到 IP 层然后进行分包的可能。

如果 TCP/UDP 往 IP 层发送数据时，因为物理网络层一般要限制每次发送数据帧的最大长度。所以 IP 层接收到一份要发送的 IP 数据报时，它要判断向本地哪个接口发送数据（选路），并查询该接口获得其 MTU。IP 把 MTU 与数据报长度进行比较，如果太长了一次发送不下（超过 MTU）则需要则进行分片。分片可以发生在原始发送端主机上，也可以发生在中间路由器上。UDP 无法避免分片（除非应用层知道路径 MTU 并控制 UDP 报文大小），TCP 则通过 MSS 协商来避免分片发生。

## 三次握手中协商了 MSS 就不会改变了吗？

不是，每次执行 TCP 发送消息时，会重新计算一次 MSS，再进行分段操作。

## 对端不传 MSS 会怎么样？

假如对方不传，那么 MSS 默认为 536 byte。

## RST？出现 RST 的几种情况？

在 TCP 协议中 RST 表示复位，用来异常的关闭连接，在 TCP 的设计中它是不可或缺的。发送 RST 包关闭连接时，不必等缓冲区的包都发出去，直接就丢弃缓存区的包发送 RST 包。而接收端收到 RST 包后，也不必发送 ACK 包来确认。

服务端端口未打开、对端提前关闭连接等很多情况都会观察到 RST。

## TCP 粘包？

TCP 粘包会导致解析网络包失败，可能发生在发送端或者接收端。

- 发送端粘包：发送端需要等缓冲区满才发送出去，造成多个包粘一起。
- 接收方粘包：接收方不及时接收缓冲区的包，造成多个包接收。

UDP 不会有粘包是因为 UDP 有消息保护边界。

## TCP/IP 五层模型和 OSI 七层模型？

- 五层模型：物理层/链路层/网络层/传输层/应用层
- 七层模型：物理层/链路层/网络层/传输层/会话层/表示层/应用层

## 判断端到端之间是否存在防火墙？

可以用 traceroute 尝试不同协议和端口去做判断。